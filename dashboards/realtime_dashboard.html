<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Kidjamo - Dashboard Temps R√©el</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aws-sdk@2.1462.0/dist/aws-sdk.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-item {
            text-align: center;
            flex: 1;
        }

        .status-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alerts-section {
            grid-column: 1 / -1;
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .alert-critical {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .alert-warning {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
        }

        .alert-info {
            background: linear-gradient(135deg, #42a5f5, #1976d2);
            color: white;
        }

        .alert-icon {
            font-size: 1.5em;
            margin-right: 15px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-time {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            color: #7f8c8d;
            margin-top: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #27ae60;
        }

        .status-disconnected {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 30px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Kidjamo - Surveillance Temps R√©el</h1>
            <p>Monitoring IoT avec D√©tection d'Alertes Automatique</p>
        </div>

        <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionText">Connexion en cours...</span>
            <span style="margin-left: auto;" id="lastUpdate">Derni√®re mise √† jour: --</span>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="totalRecords">0</div>
                <div class="status-label">Mesures Re√ßues</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="alertsCount">0</div>
                <div class="status-label">Alertes G√©n√©r√©es</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="currentTemp">--¬∞C</div>
                <div class="status-label">Temp√©rature</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="batteryLevel">--%</div>
                <div class="status-label">Batterie Bracelet</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä Acc√©l√©ration Temps R√©el</h3>
                <div class="chart-container">
                    <canvas id="accelerationChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üå°Ô∏è Temp√©rature & Gyroscope</h3>
                <div class="chart-container">
                    <canvas id="tempGyroChart"></canvas>
                </div>
            </div>

            <div class="card alerts-section">
                <h3>üö® Alertes Temps R√©el</h3>
                <div id="alertsContainer">
                    <div class="alert-item alert-info">
                        <div class="alert-icon">‚ÑπÔ∏è</div>
                        <div class="alert-content">
                            <div>Syst√®me de surveillance actif</div>
                            <div class="alert-time">En attente de donn√©es...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üìà M√©triques de Performance</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="dataRate">0</div>
                    <div class="metric-label">Donn√©es/min</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgAcceleration">0.0</div>
                    <div class="metric-label">Acc√©l. Moyenne (m/s¬≤)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="maxAcceleration">0.0</div>
                    <div class="metric-label">Acc√©l. Max (m/s¬≤)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="uptime">00:00:00</div>
                    <div class="metric-label">Temps d'activit√©</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üè• Kidjamo - Syst√®me de Surveillance Dr√©panocytose | Donn√©es via AWS Kinesis</p>
        </div>
    </div>

    <script>
        // Configuration AWS (√† adapter selon votre setup)
        const AWS_CONFIG = {
            region: 'eu-west-1',
            identityPoolId: 'YOUR_IDENTITY_POOL_ID', // √Ä remplacer
            streamName: 'kidjamo-dev-iot-measurements',
            s3Bucket: 'kidjamo-dev-datalake-e75d5213'
        };

        // Seuils d'alerte (identiques √† Kinesis Lambda)
        const ALERT_THRESHOLDS = {
            fall_detection: 15.0,    // m/s¬≤
            hyperactivity: 12.0      // m/s¬≤
        };

        // Variables globales
        let charts = {};
        let startTime = new Date();
        let totalRecords = 0;
        let alertsCount = 0;
        let recentData = [];
        let isConnected = false;

        // Initialisation des graphiques
        function initCharts() {
            // Graphique d'acc√©l√©ration
            const accelCtx = document.getElementById('accelerationChart').getContext('2d');
            charts.acceleration = new Chart(accelCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Acc√©l√©ration (m/s¬≤)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Acc√©l√©ration (m/s¬≤)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Graphique temp√©rature et gyroscope
            const tempGyroCtx = document.getElementById('tempGyroChart').getContext('2d');
            charts.tempGyro = new Chart(tempGyroCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temp√©rature (¬∞C)',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Gyroscope (¬∞/s)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temp√©rature (¬∞C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Gyroscope (¬∞/s)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Fonction de d√©tection d'alertes (logique identique √† Kinesis)
        function detectAlerts(data) {
            const alerts = [];

            // Calculer les magnitudes
            const accelMagnitude = Math.sqrt(
                Math.pow(data.accel_x, 2) +
                Math.pow(data.accel_y, 2) +
                Math.pow(data.accel_z, 2)
            );

            const gyroMagnitude = Math.sqrt(
                Math.pow(data.gyro_x, 2) +
                Math.pow(data.gyro_y, 2) +
                Math.pow(data.gyro_z, 2)
            );

            // D√©tection de chute
            if (accelMagnitude > ALERT_THRESHOLDS.fall_detection) {
                alerts.push({
                    type: 'FALL_DETECTION',
                    severity: 'HIGH',
                    message: `üö® Chute d√©tect√©e - Acc√©l√©ration: ${accelMagnitude.toFixed(2)} m/s¬≤`,
                    value: accelMagnitude,
                    timestamp: new Date()
                });
            }

            // D√©tection d'hyperactivit√©
            if (accelMagnitude > ALERT_THRESHOLDS.hyperactivity && accelMagnitude <= ALERT_THRESHOLDS.fall_detection) {
                alerts.push({
                    type: 'HYPERACTIVITY',
                    severity: 'MEDIUM',
                    message: `‚ö° Hyperactivit√© d√©tect√©e - Acc√©l√©ration: ${accelMagnitude.toFixed(2)} m/s¬≤`,
                    value: accelMagnitude,
                    timestamp: new Date()
                });
            }

            return alerts;
        }

        // Traitement des donn√©es re√ßues
        function processData(data) {
            totalRecords++;

            // Calculer magnitude d'acc√©l√©ration
            const accelMagnitude = Math.sqrt(
                Math.pow(data.accel_x, 2) +
                Math.pow(data.accel_y, 2) +
                Math.pow(data.accel_z, 2)
            );

            const gyroMagnitude = Math.sqrt(
                Math.pow(data.gyro_x, 2) +
                Math.pow(data.gyro_y, 2) +
                Math.pow(data.gyro_z, 2)
            );

            // Ajouter aux donn√©es r√©centes
            const timestamp = new Date().toLocaleTimeString();
            recentData.push({
                timestamp,
                accelMagnitude,
                gyroMagnitude,
                temp: data.temp,
                data: data
            });

            // Garder seulement les 50 derniers points
            if (recentData.length > 50) {
                recentData.shift();
            }

            // Mettre √† jour les graphiques
            updateCharts();

            // D√©tecter les alertes
            const alerts = detectAlerts(data);
            if (alerts.length > 0) {
                alerts.forEach(alert => displayAlert(alert));
                alertsCount += alerts.length;
            }

            // Mettre √† jour l'interface
            updateUI(data);
        }

        // Mise √† jour des graphiques
        function updateCharts() {
            const labels = recentData.map(d => d.timestamp);
            const accelData = recentData.map(d => d.accelMagnitude);
            const tempData = recentData.map(d => d.temp);
            const gyroData = recentData.map(d => d.gyroMagnitude);

            // Graphique acc√©l√©ration
            charts.acceleration.data.labels = labels;
            charts.acceleration.data.datasets[0].data = accelData;
            charts.acceleration.update('none');

            // Graphique temp√©rature et gyroscope
            charts.tempGyro.data.labels = labels;
            charts.tempGyro.data.datasets[0].data = tempData;
            charts.tempGyro.data.datasets[1].data = gyroData;
            charts.tempGyro.update('none');
        }

        // Affichage des alertes
        function displayAlert(alert) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertElement = document.createElement('div');

            let alertClass = 'alert-info';
            let icon = '‚ÑπÔ∏è';

            if (alert.severity === 'HIGH') {
                alertClass = 'alert-critical';
                icon = 'üö®';
            } else if (alert.severity === 'MEDIUM') {
                alertClass = 'alert-warning';
                icon = '‚ö†Ô∏è';
            }

            alertElement.className = `alert-item ${alertClass}`;
            alertElement.innerHTML = `
                <div class="alert-icon">${icon}</div>
                <div class="alert-content">
                    <div>${alert.message}</div>
                    <div class="alert-time">${alert.timestamp.toLocaleString()}</div>
                </div>
            `;

            // Ajouter en haut de la liste
            alertsContainer.insertBefore(alertElement, alertsContainer.firstChild);

            // Garder seulement les 10 derni√®res alertes
            while (alertsContainer.children.length > 10) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }

        // Mise √† jour de l'interface
        function updateUI(data) {
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('alertsCount').textContent = alertsCount;
            document.getElementById('currentTemp').textContent = `${data.temp.toFixed(1)}¬∞C`;
            document.getElementById('lastUpdate').textContent = `Derni√®re mise √† jour: ${new Date().toLocaleTimeString()}`;

            // Calculer m√©triques
            if (recentData.length > 0) {
                const avgAccel = recentData.reduce((sum, d) => sum + d.accelMagnitude, 0) / recentData.length;
                const maxAccel = Math.max(...recentData.map(d => d.accelMagnitude));

                document.getElementById('avgAcceleration').textContent = avgAccel.toFixed(2);
                document.getElementById('maxAcceleration').textContent = maxAccel.toFixed(2);
            }

            // Temps d'activit√©
            const uptime = new Date() - startTime;
            const hours = Math.floor(uptime / 3600000);
            const minutes = Math.floor((uptime % 3600000) / 60000);
            const seconds = Math.floor((uptime % 60000) / 1000);
            document.getElementById('uptime').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Simulation de donn√©es en temps r√©el (√† remplacer par vraie connexion Kinesis)
        function simulateRealtimeData() {
            const mockData = {
                device_id: 'MPU_Christian_8266MOD',
                accel_x: (Math.random() - 0.5) * 20,
                accel_y: (Math.random() - 0.5) * 20,
                accel_z: 9.8 + (Math.random() - 0.5) * 4,
                gyro_x: (Math.random() - 0.5) * 500,
                gyro_y: (Math.random() - 0.5) * 500,
                gyro_z: (Math.random() - 0.5) * 500,
                temp: 25 + (Math.random() - 0.5) * 10,
                timestamp: new Date().toISOString()
            };

            // Parfois g√©n√©rer des valeurs √©lev√©es pour tester les alertes
            if (Math.random() < 0.05) { // 5% de chance
                mockData.accel_x *= 3;
                mockData.accel_y *= 3;
                mockData.accel_z *= 2;
            }

            processData(mockData);

            // Mise √† jour du statut de connexion
            updateConnectionStatus(true);
        }

        // Mise √† jour du statut de connexion
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');

            if (connected !== isConnected) {
                isConnected = connected;

                if (connected) {
                    dot.className = 'status-dot status-connected';
                    text.textContent = 'üü¢ Connect√© - Donn√©es temps r√©el';
                } else {
                    dot.className = 'status-dot status-disconnected';
                    text.textContent = 'üî¥ D√©connect√© - Reconnexion...';
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();

            // D√©marrer la simulation (remplacer par vraie connexion Kinesis)
            setInterval(simulateRealtimeData, 2000); // Toutes les 2 secondes

            // Mise √† jour des m√©triques toutes les secondes
            setInterval(() => {
                const dataRate = Math.round(totalRecords / ((new Date() - startTime) / 60000));
                document.getElementById('dataRate').textContent = dataRate;

                // Mettre √† jour le temps d'activit√©
                if (recentData.length > 0) {
                    updateUI(recentData[recentData.length - 1].data);
                }
            }, 1000);

            console.log('üöÄ Dashboard Temps R√©el Kidjamo initialis√©');
        });
    </script>
</body>
</html>

